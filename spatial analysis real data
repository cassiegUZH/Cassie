#####-----
## Mantel test
#####-----
## Preparations
  library(vegan)
  library(dplyr)
  
  rm(list=ls())
  setwd("C:/Users/cassi/OneDrive - Universität Zürich UZH/PhD/Genetics/Analysis/Preliminary")
 
  d.real <- read.csv("d.tools3.csv", sep = ";")
  d.genes <- read.csv("d.genes3.csv", sep = ";")

## geographical distance
  # euclidean distance in degrees
  m.geo <- distinct(d.real[, c(1,4,5)], population, .keep_all = T)
  rownames(m.geo) <- m.geo$population
  m.geo <- m.geo[,-1]
  geodist <- vegdist(m.geo, method = "euclidean", diag=F, upper=F)
  geodist
  
## cultural distance
  # binary data as testcult; columns=presence or absence of trait
  # method "jaccard" and "gower" give different results: we need to discuss which is best 
  m.cult <- distinct(d.real[, c(1,6,11)], population, tool, .keep_all = T)
  m.cult[is.na(m.cult) == T] <- 0
  m.cult <- tidyr::spread(m.cult, tool, use)
  rownames(m.cult) <- m.cult$population
  m.cult <- m.cult[,-1]
  cultdist <- vegdist(m.cult, method = "jaccard", diag=F, upper=F, na.rm = T)
  cultdist
  
  
## genetic distance
  # seems you already have a matrix, so you need to convert it 
  m.ibd <- d.genes[, c(2,3,5)]
  m.ibd<- tidyr::spread(m.ibd, population1, IBDmax)
  m.ibd <- rbind(c(NA), m.ibd)
  m.ibd$population2[1] <- "Bafing"
  rownames(m.ibd) <- m.ibd$population2
  m.ibd <- m.ibd[,-1]
  m.ibd <- cbind(m.ibd, c(NA))
  colnames(m.ibd)[ncol(m.ibd)] <- "Tai"
  ibddist <- as.dist(m.ibd, diag=F, upper=F)
  ibddist
  
  m.sim <- d.genes[, c(2,3,6)]
  m.sim<- tidyr::spread(m.sim, population1, similarity)
  m.sim <- rbind(c(NA), m.sim)
  m.sim$population2[1] <- "Bafing"
  rownames(m.sim) <- m.sim$population2
  m.sim <- m.sim[,-1]
  m.sim <- cbind(m.sim, c(NA))
  colnames(m.sim)[ncol(m.sim)] <- "Tai"
  simdist <- as.dist(m.sim, diag=F, upper=F)
  simdist
  
## calculate binary correlations between the distances  
  # simple Mantel test
  detach(package:vegan) # because vegn also has a Mantel function
  #library(vegan)
  library(ecodist)
  # mantelr is correlation, pval3 is two-tailed p value
  # ?mantel 
  mantel(geodist ~ ibddist,nperm = 10000,mrank = T)

  # partial Mantel test
  # with y ~ x1 + x2, you calculate correlation between 
  # y and x1 controlling for x2 
  mantel(cultdist ~ ibddist + geodist, nperm = 10000, mrank = T)
